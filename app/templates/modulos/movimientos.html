{% extends 'base.html' %}

{% block title %}Gesti√≥n de Movimientos - Grupo Forno{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style-movimientos.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <img src="{{ url_for('static', filename='img/logo-forno-2.png') }}" 
                    alt="Grupo Forno" 
                    style="width: 150px; height: 75px; object-fit: contain;">
            </div>
            <h2>Grupo Forno</h2>
        </div>
        
        <div class="user-info">
            <div class="user-avatar">{{ session.user_name[0] }}</div>
            <div class="user-details">
                <p class="user-name">{{ session.user_name }}</p>
                <p class="user-role">{{ session.user_role }}</p>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <a href="{{ url_for('dashboard.index') }}" class="nav-item">
                <span class="nav-icon">üè†</span>
                <span>Dashboard</span>
            </a>
            <a href="{{ url_for('movimientos.index') }}" class="nav-item active">
                <span class="nav-icon">üîÑ</span>
                <span>Movimientos</span>
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <a href="{{ url_for('auth.logout') }}" class="btn btn-logout">
                <span>üö™</span> Cerrar Sesi√≥n
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="content-header">
            <h1>Gesti√≥n de Movimientos</h1>
            <p>Asigna, traslada y ajusta productos en el inventario</p>
        </header>

        <!-- TAB: LISTA DE MOVIMIENTOS -->
        {% if tab == 'lista' %}
        <section class="movimientos-section">
            <div class="section-header">
                <h2>Historial de Movimientos</h2>
                <div class="header-actions">
                    <a href="{{ url_for('movimientos.asignar') }}" class="btn btn-primary">üì• Asignar</a>
                    <a href="{{ url_for('movimientos.trasladar') }}" class="btn btn-secondary">üîÑ Trasladar</a>
                    <a href="{{ url_for('movimientos.ajustar') }}" class="btn btn-warning">‚öôÔ∏è Ajustar</a>
                </div>
            </div>

            {% if movimientos %}
            <div class="movimientos-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>Producto</th>
                            <th>Categor√≠a</th>
                            <th>Cliente/Empresa</th>
                            <th>Cantidad</th>
                            <th>Motivo</th>
                            <th>Responsable</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mov in movimientos %}
                        <tr>
                            <td><strong>#{{ mov.id_movimiento_producto }}</strong></td>
                            <td>{{ mov.fecha_movimiento }}</td>
                            <td>{{ mov.marca }}</td>
                            <td>{{ mov.nombre_categoria }}</td>
                            <td>
                                {% if mov.empresa %}
                                    <span class="proveedor-info" title="{{ mov.nombre_proveedor }}">
                                        {{ mov.empresa }}
                                    </span>
                                {% else %}
                                    <span class="text-muted">Sin asignar</span>
                                {% endif %}
                            </td>
                            <td><strong>{{ mov.cantidad_producto }}</strong></td>
                            <td>
                                <span class="badge badge-{{ mov.motivo.lower().replace(' ', '-') }}">
                                    {{ mov.motivo }}
                                </span>
                            </td>
                            <td>{{ mov.nombre }} {{ mov.apellido_paterno if mov.nombre else 'Sistema' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <p>No hay movimientos registrados</p>
            </div>
            {% endif %}
        </section>

        <!-- TAB: ASIGNAR -->
        {% elif tab == 'asignar' %}
        <section class="form-section">
            <h2>üì• Asignar Producto a Inventario</h2>
            <p class="form-subtitle">Ubica productos de recepciones en estantes espec√≠ficos</p>
            
            <form method="POST" class="movimientos-form">
                <div class="form-group">
                    <label for="id_detalle_ingreso">Producto Pendiente *</label>
                    <select id="id_detalle_ingreso" name="id_detalle_ingreso" required onchange="actualizarProveedor()">
                        <option value="">-- Seleccionar Producto --</option>
                        {% for prod in productos %}
                        <option value="{{ prod.id_detalle_ingreso }}" 
                                data-id-pedido="{{ prod.id_pedido }}"
                                data-id-producto="{{ prod.id_producto }}"
                                data-proveedor="{{ prod.id_proveedor }}"
                                data-empresa="{{ prod.empresa }}"
                                data-nombre-proveedor="{{ prod.nombre_proveedor }}"
                                data-cantidad="{{ prod.cantidad_recibida }}">
                            {{ prod.marca }} - {{ prod.nombre_categoria }} | 
                            Proveedor: {{ prod.nombre_proveedor }} (Cantidad: {{ prod.cantidad_recibida }})
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <input type="hidden" id="id_pedido" name="id_pedido">
                <input type="hidden" id="id_producto" name="id_producto">
                <input type="hidden" id="id_proveedor" name="id_proveedor">

                <div class="proveedor-info-box" id="proveedor-info" style="display: none;">
                    <div class="info-item">
                        <span class="info-label">üè¢ Proveedor/Empresa:</span>
                        <span class="info-value" id="empresa-text">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">üë§ Contacto:</span>
                        <span class="info-value" id="proveedor-text">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">üì¶ Cantidad Recibida:</span>
                        <span class="info-value" id="cantidad-recibida-text">-</span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="id_almacen">Almac√©n *</label>
                        <select id="id_almacen" name="id_almacen" required onchange="cargarEstantes()">
                            <option value="">-- Seleccionar Almac√©n --</option>
                            {% for almacen in almacenes %}
                            <option value="{{ almacen.id_almacen }}">
                                {{ almacen.nombre_almacen }} (Disponible: {{ almacen.disponible }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="id_estante">Estante *</label>
                        <select id="id_estante" name="id_estante" required>
                            <option value="">-- Primero seleccione almac√©n --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cantidad">Cantidad a Asignar *</label>
                        <input type="number" id="cantidad" name="cantidad" required min="1" placeholder="M√°ximo: (ver cantidad recibida)">
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">üíæ Asignar al Inventario</button>
                    <a href="{{ url_for('movimientos.index') }}" class="btn btn-secondary">‚ùå Cancelar</a>
                </div>
            </form>
        </section>

        <!-- TAB: TRASLADAR -->
        {% elif tab == 'trasladar' %}
        <section class="form-section">
            <h2>üîÑ Trasladar Producto</h2>
            <p class="form-subtitle">Mueve productos entre estantes o almacenes</p>
            
            <form method="POST" class="movimientos-form">
                <div class="form-group">
                    <label for="id_inventario">Producto en Inventario *</label>
                    <select id="id_inventario" name="id_inventario" required>
                        <option value="">-- Seleccionar Producto --</option>
                        {% for inv in inventarios %}
                        <option value="{{ inv.id_inventario }}">
                            {{ inv.marca }} - {{ inv.nombre_almacen }} / {{ inv.pasillo }} | 
                            {% if inv.empresa %}Proveedor: {{ inv.empresa }}{% else %}Sin proveedor{% endif %} 
                            (Stock: {{ inv.stock_producto }})
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="almacen_destino">Almac√©n Destino *</label>
                        <select id="almacen_destino" name="almacen_destino" required onchange="cargarEstantesDestino()">
                            <option value="">-- Seleccionar Almac√©n --</option>
                            {% for almacen in almacenes %}
                            <option value="{{ almacen.id_almacen }}">{{ almacen.nombre_almacen }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="id_estante_destino">Estante Destino *</label>
                        <select id="id_estante_destino" name="id_estante_destino" required>
                            <option value="">-- Primero seleccione almac√©n --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cantidad">Cantidad *</label>
                        <input type="number" id="cantidad" name="cantidad" required min="1">
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">üîÑ Realizar Traslado</button>
                    <a href="{{ url_for('movimientos.index') }}" class="btn btn-secondary">‚ùå Cancelar</a>
                </div>
            </form>
        </section>

        <!-- TAB: AJUSTAR -->
        {% elif tab == 'ajustar' %}
        <section class="form-section">
            <h2>‚öôÔ∏è Ajustar Stock</h2>
            <p class="form-subtitle">Corrige inventario por mermas, diferencias o errores</p>
            
            <form method="POST" class="movimientos-form">
                <div class="form-group">
                    <label for="id_inventario">Producto en Inventario *</label>
                    <select id="id_inventario" name="id_inventario" required>
                        <option value="">-- Seleccionar Producto --</option>
                        {% for inv in inventarios %}
                        <option value="{{ inv.id_inventario }}">
                            {{ inv.marca }} - {{ inv.nombre_almacen }} / {{ inv.pasillo }} | 
                            {% if inv.empresa %}Proveedor: {{ inv.empresa }}{% else %}Sin proveedor{% endif %} 
                            (Stock: {{ inv.stock_producto }})
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="ajuste">Ajuste (+ aumenta / - disminuye) *</label>
                        <input type="number" id="ajuste" name="ajuste" required placeholder="Ej: -5 para reducir, +3 para aumentar">
                    </div>
                    <div class="form-group">
                        <label for="motivo">Motivo *</label>
                        <select id="motivo" name="motivo" required>
                            <option value="Ajuste">Ajuste de Inventario</option>
                            <option value="Merma">Merma</option>
                            <option value="Da√±o">Producto Da√±ado</option>
                            <option value="Correcci√≥n">Correcci√≥n de Error</option>
                        </select>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">üíæ Aplicar Ajuste</button>
                    <a href="{{ url_for('movimientos.index') }}" class="btn btn-secondary">‚ùå Cancelar</a>
                </div>
            </form>
        </section>
        {% endif %}
    </main>
</div>

<script>
function actualizarProveedor() {
    const select = document.getElementById('id_detalle_ingreso');
    const option = select.options[select.selectedIndex];
    
    const detalleId = option.value;
    const pedidoId = option.getAttribute('data-id-pedido');
    const productoId = option.getAttribute('data-id-producto');
    const proveedorId = option.getAttribute('data-proveedor');
    const empresa = option.getAttribute('data-empresa');
    const nombreProveedor = option.getAttribute('data-nombre-proveedor');
    const cantidadRecibida = option.getAttribute('data-cantidad');
    
    document.getElementById('id_pedido').value = pedidoId || '';
    document.getElementById('id_producto').value = productoId || '';
    document.getElementById('id_proveedor').value = proveedorId || '';
    
    const infoBox = document.getElementById('proveedor-info');
    if (detalleId) {
        document.getElementById('empresa-text').textContent = empresa || '-';
        document.getElementById('proveedor-text').textContent = nombreProveedor || '-';
        document.getElementById('cantidad-recibida-text').textContent = cantidadRecibida || '-';
        document.getElementById('cantidad').max = cantidadRecibida || '';
        infoBox.style.display = 'block';
    } else {
        infoBox.style.display = 'none';
        document.getElementById('cantidad').max = '';
    }
}

function cargarEstantes() {
    const almacenId = document.getElementById('id_almacen').value;
    const estanteSelect = document.getElementById('id_estante');
    
    if (!almacenId) {
        estanteSelect.innerHTML = '<option value="">-- Primero seleccione almac√©n --</option>';
        return;
    }
    
    fetch(`/movimientos/estantes/${almacenId}`)
        .then(response => response.text())
        .then(html => {
            estanteSelect.innerHTML = html;
        })
        .catch(error => {
            estanteSelect.innerHTML = '<option value="">Error al cargar estantes</option>';
            console.error('Error:', error);
        });
}

function cargarEstantesDestino() {
    const almacenId = document.getElementById('almacen_destino').value;
    const estanteSelect = document.getElementById('id_estante_destino');
    
    if (!almacenId) {
        estanteSelect.innerHTML = '<option value="">-- Primero seleccione almac√©n --</option>';
        return;
    }
    
    fetch(`/movimientos/estantes/${almacenId}`)
        .then(response => response.text())
        .then(html => {
            estanteSelect.innerHTML = html;
        })
        .catch(error => {
            estanteSelect.innerHTML = '<option value="">Error al cargar estantes</option>';
            console.error('Error:', error);
        });
}
</script>
{% endblock %}